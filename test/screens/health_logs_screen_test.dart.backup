import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:stml_careconnect/screens/health_logs_screen.dart';
import 'package:stml_careconnect/app/app_routes.dart';
import 'package:stml_careconnect/screens/messages_screen.dart';
import 'package:stml_careconnect/theme/app_theme.dart';

void main() {
  group('HealthLogsScreen Widget Tests', () {
    testWidgets('Health Logs screen renders correctly', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        MaterialApp(
          theme: ThemeData(primaryColor: AppColors.primary),
          home: const HealthLogsScreen(),
          routes: {
            AppRoutes.dashboard: (context) =>
                const Scaffold(body: Text('Dashboard')),
            AppRoutes.tasks: (context) => const Scaffold(body: Text('Tasks')),
            AppRoutes.calendar: (context) =>
                const Scaffold(body: Text('Calendar')),
            AppRoutes.messages: (context) =>
                const Scaffold(body: Text('Messages')),
            AppRoutes.profile: (context) =>
                const Scaffold(body: Text('Profile')),
          },
        ),
      );

      expect(find.text('Health Logs'), findsOneWidget);
      expect(find.byIcon(Icons.arrow_back), findsOneWidget);
      expect(find.text('New'), findsOneWidget);

      expect(find.text('BP Today'), findsOneWidget);
      expect(find.text('120/80'), findsOneWidget);
      expect(find.text('mmHg'), findsOneWidget);

      expect(find.text('Medications'), findsOneWidget);
      expect(find.text('2/2'), findsOneWidget);
      expect(find.text('Completed'), findsOneWidget);

      expect(find.text('Meals'), findsAtLeastNWidgets(1));
      expect(find.text('1,240'), findsOneWidget);
      expect(find.text('Calories'), findsOneWidget);

      expect(find.text('Mood'), findsAtLeastNWidgets(1));
      expect(find.text('Good'), findsOneWidget);
      expect(find.text('Improving'), findsOneWidget);

      expect(find.text('All'), findsOneWidget);
      expect(find.text('Vitals'), findsOneWidget);
      expect(find.text('Meds'), findsOneWidget);
      expect(find.text('Symptoms'), findsOneWidget);
      expect(find.text('Activity'), findsOneWidget);

      expect(find.text('Blood Pressure'), findsOneWidget);
      expect(find.text('systolic: 120'), findsOneWidget);
      expect(find.text('diastolic: 80'), findsOneWidget);

      expect(find.text('Mood Check'), findsOneWidget);
      expect(find.text('Feeling good today'), findsOneWidget);

      expect(find.text('Medication Taken'), findsOneWidget);
      expect(find.text('Morning medications completed'), findsOneWidget);

      expect(find.text('Breakfast'), findsOneWidget);
      expect(find.text('Oatmeal with berries, green tea'), findsOneWidget);

      expect(find.text('No symptoms reported'), findsOneWidget);

      expect(find.byType(FloatingActionButton), findsOneWidget);

      expect(find.text('Home'), findsOneWidget);
      expect(find.text('Tasks'), findsOneWidget);
      expect(find.text('Calendar'), findsOneWidget);
      expect(find.text('Messages'), findsOneWidget);
      expect(find.text('Profile'), findsOneWidget);
    });

    testWidgets('Home icon in bottom nav is highlighted', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        MaterialApp(
          theme: ThemeData(primaryColor: AppColors.primary),
          home: const HealthLogsScreen(),
        ),
      );

      final bottomNavBar = tester.widget<BottomNavigationBar>(
        find.byType(BottomNavigationBar),
      );

      expect(bottomNavBar.currentIndex, 0);
    });

    testWidgets('Back button navigation works', (WidgetTester tester) async {
      await tester.pumpWidget(
        MaterialApp(
          home: const Scaffold(body: Text('Previous Screen')),
          onGenerateRoute: (settings) {
            if (settings.name == '/health-logs') {
              return MaterialPageRoute(
                builder: (context) => const HealthLogsScreen(),
              );
            }
            return null;
          },
        ),
      );

      final BuildContext context = tester.element(find.text('Previous Screen'));
      Navigator.pushNamed(context, '/health-logs');
      await tester.pumpAndSettle();

      expect(find.text('Health Logs'), findsOneWidget);

      await tester.tap(find.byIcon(Icons.arrow_back));
      await tester.pumpAndSettle();

      expect(find.text('Previous Screen'), findsOneWidget);
    });

    testWidgets('BP Today card shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final bpCard = find.text('BP Today');
      expect(bpCard, findsOneWidget);

      await tester.tap(bpCard);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Blood Pressure Details - View your blood pressure history and trends',
        ),
        findsOneWidget,
      );
    });

    testWidgets('Medications card shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final medsCard = find.text('Medications');
      expect(medsCard, findsOneWidget);

      await tester.tap(medsCard);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Medication Details - View your medication schedule and completion status',
        ),
        findsOneWidget,
      );
    });

    testWidgets('Meals card shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final mealsCard = find.text('1,240');
      expect(mealsCard, findsOneWidget);

      await tester.tap(mealsCard);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Meal Details - View your daily calorie intake and nutrition information',
        ),
        findsOneWidget,
      );
    });

    testWidgets('Mood card shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final moodCard = find.text('Good');
      expect(moodCard, findsOneWidget);

      await tester.tap(moodCard);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Mood Details - View your mood patterns and emotional wellness tracking',
        ),
        findsOneWidget,
      );
    });

    testWidgets('Floating action button shows professional message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final fab = find.byType(FloatingActionButton);
      expect(fab, findsOneWidget);

      await tester.tap(fab);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Add Health Log - Feature coming soon to create new health entries',
        ),
        findsOneWidget,
      );
    });

    testWidgets('New button in header shows add log message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final newButton = find.text('New');
      expect(newButton, findsOneWidget);

      await tester.tap(newButton);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Add Health Log - Feature coming soon to create new health entries',
        ),
        findsOneWidget,
      );
    });

    testWidgets('Blood Pressure log entry shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final bpEntry = find.text('Blood Pressure');
      expect(bpEntry, findsOneWidget);

      await tester.tap(bpEntry);
      await tester.pumpAndSettle();

      expect(
        find.text('Blood Pressure - Tap to view full details and edit entry'),
        findsOneWidget,
      );
    });

    testWidgets('Mood Check log entry shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final moodEntry = find.text('Mood Check');
      expect(moodEntry, findsOneWidget);

      await tester.tap(moodEntry);
      await tester.pumpAndSettle();

      expect(
        find.text('Mood Check - Tap to view full details and edit entry'),
        findsOneWidget,
      );
    });

    testWidgets('Medication Taken log entry shows contextual message', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final medEntry = find.text('Medication Taken');
      expect(medEntry, findsOneWidget);

      await tester.tap(medEntry);
      await tester.pumpAndSettle();

      expect(
        find.text('Medication Taken - Tap to view full details and edit entry'),
        findsOneWidget,
      );
    });

    testWidgets('Log entries display correct details', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(find.text('systolic: 120'), findsOneWidget);
      expect(find.text('diastolic: 80'), findsOneWidget);
      expect(find.text('heartRate: 72'), findsOneWidget);

      expect(find.text('mood: happy'), findsOneWidget);
      expect(find.text('energy: high'), findsOneWidget);

      expect(
        find.text('medications: Lisinopril 10mg, Metformin 500mg'),
        findsOneWidget,
      );

      expect(find.text('calories: 320'), findsOneWidget);
      expect(find.text('protein: 12'), findsOneWidget);
    });

    testWidgets('Log entries display correct tags', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(find.text('vitals'), findsOneWidget);
      expect(find.text('mood'), findsOneWidget);
      expect(find.text('medication'), findsOneWidget);
      expect(find.text('meal'), findsOneWidget);
      expect(find.text('symptoms'), findsOneWidget);
    });

    testWidgets('Log entries display timestamps', (WidgetTester tester) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(find.text('1 hour ago'), findsOneWidget);
      expect(find.text('2 hours ago'), findsOneWidget);
      expect(find.text('3 hours ago'), findsOneWidget);
      expect(find.text('4 hours ago'), findsOneWidget);
      expect(find.text('1 day ago'), findsOneWidget);
    });

    testWidgets('Bottom navigation navigates to dashboard', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        MaterialApp(
          home: const HealthLogsScreen(),
          routes: {
            AppRoutes.dashboard: (context) =>
                const Scaffold(body: Text('Dashboard Screen')),
          },
        ),
      );

      await tester.tap(find.text('Home'));
      await tester.pumpAndSettle();

      expect(find.text('Dashboard Screen'), findsOneWidget);
    });

    testWidgets('Now banner View button shows appointment details', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final viewButton = find.text('View');
      expect(viewButton, findsOneWidget);

      await tester.tap(viewButton);
      await tester.pumpAndSettle();

      expect(
        find.text(
          'Physical Therapy Appointment at 2:00 PM at clinic - Tap to view full details',
        ),
        findsOneWidget,
      );
    });

    testWidgets('Summary cards show correct status icons', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(find.byIcon(Icons.trending_up), findsOneWidget);
    });

    testWidgets('Tab selection changes state', (WidgetTester tester) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final vitalsTab = find.text('Vitals');
      expect(vitalsTab, findsOneWidget);

      await tester.tap(vitalsTab);
      await tester.pump();

      expect(find.text('Vitals'), findsOneWidget);
    });
  });

  group('HealthLogsScreen Accessibility Tests', () {
    testWidgets('Back button has accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final backButton = find.byIcon(Icons.arrow_back);
      expect(backButton, findsOneWidget);

      // Check semantics using semantics finder
      expect(find.bySemanticsLabel(RegExp(r'Back')), findsOneWidget);
    });

    testWidgets('Health Logs title is marked as header', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final title = find.text('Health Logs');
      expect(title, findsOneWidget);

      // Verify header semantics
      final semantics = tester.getSemantics(title);
      expect(semantics.isHeader, true);
    });

    testWidgets('New button has accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      // Check for semantic label
      expect(
        find.bySemanticsLabel(RegExp(r'Add new health log')),
        findsOneWidget,
      );
    });

    testWidgets('BP Today card has descriptive accessibility label', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      // Check for semantic label with blood pressure info
      expect(
        find.bySemanticsLabel(RegExp(r'Blood pressure today.*120 over 80')),
        findsOneWidget,
      );
    });

    testWidgets('Medications card has descriptive accessibility label', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(
          RegExp(r'Medications today.*2 out of 2 completed'),
        ),
        findsOneWidget,
      );
    });

    testWidgets('Meals card has descriptive accessibility label', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(RegExp(r'Meals today.*1,240 calories')),
        findsOneWidget,
      );
    });

    testWidgets('Mood card has descriptive accessibility label', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(RegExp(r'Mood today.*good.*improving')),
        findsOneWidget,
      );
    });

    testWidgets('All filter tab has correct accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(RegExp(r'All filter.*selected')),
        findsOneWidget,
      );
    });

    testWidgets('Vitals filter tab has correct accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(find.bySemanticsLabel(RegExp(r'Vitals filter')), findsOneWidget);
    });

    testWidgets('Meds filter tab has correct accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(RegExp(r'Medications filter')),
        findsOneWidget,
      );
    });

    testWidgets('Blood Pressure log entry has accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(
          RegExp(r'Blood Pressure.*1 hour ago.*vitals.*systolic 120'),
        ),
        findsOneWidget,
      );
    });

    testWidgets('Mood Check log entry has accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(
          RegExp(r'Mood Check.*Feeling good today.*2 hours ago.*mood'),
        ),
        findsOneWidget,
      );
    });

    testWidgets('Floating action button has accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(RegExp(r'Add new health log entry')),
        findsOneWidget,
      );
    });

    testWidgets('Appointment banner has accessibility semantics', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      expect(
        find.bySemanticsLabel(
          RegExp(r'Current appointment.*Physical Therapy.*2:00 PM.*clinic'),
        ),
        findsOneWidget,
      );
    });

    testWidgets('Tab selection updates accessibility state', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(MaterialApp(home: const HealthLogsScreen()));

      final vitalsTab = find.text('Vitals');
      await tester.tap(vitalsTab);
      await tester.pump();

      // After selecting Vitals tab, it should have "selected" in label
      expect(
        find.bySemanticsLabel(RegExp(r'Vitals filter.*selected')),
        findsOneWidget,
      );
    });
  });

  group('HealthLogsScreen Navigation Tests', () {
    testWidgets('Bottom nav callback covers current-index return path', (
      WidgetTester tester,
    ) async {
      await tester.pumpWidget(
        MaterialApp(
          theme: ThemeData(primaryColor: AppColors.primary),
          home: const MessagesScreen(),
        ),
      );

      final nav = tester.widget<BottomNavigationBar>(
        find.byType(BottomNavigationBar),
      );
      nav.onTap?.call(3);
      await tester.pump();
      expect(find.text('Messages'), findsAtLeastNWidgets(1));
    });
  });
}
